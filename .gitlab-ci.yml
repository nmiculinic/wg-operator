stages:
  - build

variables:
  TAG_FULL: ${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA} # Warning duplication in IMAGE_FULL. It's here due to gitlab...
  IMAGE_BRANCH: ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}
  IMAGE_FULL: ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}

go_build:
  variables:
    DOCKERVERSION: 18.09.3
  before_script:
    - mkdir -p $GOPATH/src/github.com/KrakenSystems/
    - cd $GOPATH/src/github.com/KrakenSystems/
    - ln -s $(pwd)
    - export GO_PROJECT_PATH="$GOPATH/src/github.com/KrakenSystems/${CI_PROJECT_NAME}"
    - echo $GO_PROJECT_PATH
    - cd $GO_PROJECT_PATH
    - pwd
    - ls
    - go get github.com/golang/dep/cmd/dep  # Install dep
    - echo https://download.docker.com/linux/static/stable/x86_64/docker-${DOCKERVERSION}.tgz
    - curl -fsSLO https://download.docker.com/linux/static/stable/x86_64/docker-${DOCKERVERSION}.tgz
    - tar xzvf docker-${DOCKERVERSION}.tgz --strip 1 -C /usr/local/bin docker/docker
    - cd $GO_PROJECT_PATH
    - pwd
    - ls
  services:
    - docker:dind
  stage: build
  image: golang:1.12
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN ${CI_REGISTRY}
    - dep ensure -vendor-only
    - go test ./...
    - GOOS=linux GOARCH=amd64 go build -a -ldflags '-extldflags "-static"' -o build/${CI_PROJECT_PATH}-amd64 ./cmd/manager
    - |
      cat << EOF > pack.Dockerfile
      FROM alpine
      WORKDIR /bin
      COPY build/${CI_PROJECT_PATH}-amd64 /bin/${CI_PROJECT_PATH}
      ENTRYPOINT [ "/bin/${CI_PROJECT_PATH}" ]
      EOF
    - cat pack.Dockerfile
    - docker build -t ${IMAGE_FULL}-amd64 -f pack.Dockerfile .
    - docker push ${IMAGE_FULL}-amd64
    - echo "========="
    - GOOS=linux GOARCH=amd GOARM=7 go build -a -ldflags '-extldflags "-static"' -o build/${CI_PROJECT_PATH}-arm32v7 ./cmd/manager
    - |
      cat << EOF > pack.Dockerfile
      FROM arm32v7/alpine
      WORKDIR /bin
      COPY build/${CI_PROJECT_PATH}-arm32v7 /bin/${CI_PROJECT_PATH}
      ENTRYPOINT [ "/bin/${CI_PROJECT_PATH}" ]
      EOF
    - cat pack.Dockerfile
    - docker build -t ${IMAGE_FULL}-arm32v7 -f pack.Dockerfile .
    - docker push ${IMAGE_FULL}-arm32v7
    - echo "========="
    - GOOS=linux GOARCH=amd GOARM=7 go build -a -ldflags '-extldflags "-static"' -o build/${CI_PROJECT_PATH}-arm64v8 ./cmd/manager
    - |
      cat << EOF > pack.Dockerfile
      FROM arm64v8/alpine
      WORKDIR /bin
      COPY build/${CI_PROJECT_PATH}-arm64v8 /bin/${CI_PROJECT_PATH}
      ENTRYPOINT [ "/bin/${CI_PROJECT_PATH}" ]
      EOF
    - cat pack.Dockerfile
    - docker build -t ${IMAGE_FULL}-arm64v8 -f pack.Dockerfile .
    - docker push ${IMAGE_FULL}-arm64v8
    - echo "manifest magic"
    - docker manifest create ${IMAGE_FULL} ${IMAGE_FULL}-amd64 ${IMAGE_FULL}-arm32v7 ${IMAGE_FULL}-arm64v8
    - docker manifest push ${IMAGE_FULL}
    - docker manifest create ${IMAGE_BRANCH} ${IMAGE_FULL}-amd64 ${IMAGE_FULL}-arm32v7 ${IMAGE_FULL}-arm64v8
    - docker manifest push ${IMAGE_BRANCH}
  artifacts:
    paths:
      - build/
    expire_in: 1 week
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/

